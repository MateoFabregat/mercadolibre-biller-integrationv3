<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Shopify Biller Integration</title>
  <style>
    :root {
      --primary: #5c6ac4;
      --success: #50b83c;
      --warning: #f49342;
      --danger: #de3618;
      --bg: #f4f6f8;
      --card-bg: #ffffff;
      --text: #212b36;
      --text-muted: #637381;
      --border: #dfe3e8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-muted);
    }

    header .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
    }

    header .status-dot.offline { background: var(--danger); }
    header .status-dot.warning { background: var(--warning); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .card h2 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 600;
      color: var(--text);
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }

    .stat-change {
      font-size: 12px;
      margin-top: 8px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .mini-stat {
      text-align: center;
      padding: 12px;
      background: var(--bg);
      border-radius: 6px;
    }

    .mini-stat .value {
      font-size: 24px;
      font-weight: 600;
    }

    .mini-stat .label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .mini-stat.success .value { color: var(--success); }
    .mini-stat.warning .value { color: var(--warning); }
    .mini-stat.danger .value { color: var(--danger); }

    .progress-bar {
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 12px;
    }

    .progress-bar .fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    .table-card {
      grid-column: 1 / -1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success { background: #e3f1df; color: #108043; }
    .badge.warning { background: #ffc58b33; color: #9c6f19; }
    .badge.danger { background: #fbeae5; color: #bf0711; }
    .badge.info { background: #b4e1fa33; color: #084e8a; }

    .circuit-status {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .circuit {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg);
      border-radius: 6px;
    }

    .circuit .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .circuit .indicator.closed { background: var(--success); }
    .circuit .indicator.open { background: var(--danger); }
    .circuit .indicator.half-open { background: var(--warning); }

    .refresh-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .refresh-btn:hover {
      opacity: 0.9;
    }

    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .last-update {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chart-container {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 4px;
      padding-top: 20px;
    }

    .chart-bar {
      flex: 1;
      background: var(--primary);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      position: relative;
    }

    .chart-bar:hover {
      opacity: 0.8;
    }

    .chart-bar .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .chart-bar:hover .tooltip {
      opacity: 1;
    }

    .chart-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      header {
        flex-direction: column;
        gap: 12px;
      }

      .grid {
        grid-template-columns: 1fr;
      }
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .error-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .error-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    .error-item:last-child {
      border-bottom: none;
    }

    .error-item .error-type {
      font-size: 12px;
      font-weight: 600;
      color: var(--danger);
    }

    .error-item .error-message {
      font-size: 14px;
      margin: 4px 0;
    }

    .error-item .error-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <header>
    <div class="container flex-between">
      <h1>
        <span>ðŸ“Š</span> Shopify-Biller Dashboard
      </h1>
      <div class="header-actions">
        <div class="status">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">Conectando...</span>
        </div>
        <span class="last-update" id="last-update"></span>
        <button class="refresh-btn" onclick="refreshData()" id="refresh-btn">
          <span>â†»</span> Actualizar
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- MÃ©tricas principales -->
    <div class="grid">
      <div class="card">
        <h2>Comprobantes Hoy</h2>
        <div class="stat-value" id="comprobantes-hoy">-</div>
        <div class="stat-label">emitidos</div>
        <div class="progress-bar">
          <div class="fill" id="progress-hoy" style="width: 0%"></div>
        </div>
      </div>

      <div class="card">
        <h2>Total Comprobantes</h2>
        <div class="stat-value" id="total-comprobantes">-</div>
        <div class="stat-label">histÃ³rico</div>
      </div>

      <div class="card">
        <h2>Webhooks</h2>
        <div class="stats-grid">
          <div class="mini-stat success">
            <div class="value" id="webhooks-procesados">-</div>
            <div class="label">Procesados</div>
          </div>
          <div class="mini-stat warning">
            <div class="value" id="webhooks-duplicados">-</div>
            <div class="label">Duplicados</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Uptime</h2>
        <div class="stat-value" id="uptime">-</div>
        <div class="stat-label" id="uptime-label">horas</div>
      </div>
    </div>

    <!-- Circuit Breakers y Tipos -->
    <div class="grid">
      <div class="card">
        <h2>Circuit Breakers</h2>
        <div class="circuit-status" id="circuit-status">
          <div class="circuit">
            <span class="indicator closed"></span>
            <span>Cargando...</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Por Tipo de Comprobante</h2>
        <div class="stats-grid">
          <div class="mini-stat">
            <div class="value" id="etickets">-</div>
            <div class="label">e-Tickets (101)</div>
          </div>
          <div class="mini-stat">
            <div class="value" id="efacturas">-</div>
            <div class="label">e-Facturas (111)</div>
          </div>
          <div class="mini-stat warning">
            <div class="value" id="nc-etickets">-</div>
            <div class="label">NC e-Ticket (102)</div>
          </div>
          <div class="mini-stat warning">
            <div class="value" id="nc-efacturas">-</div>
            <div class="label">NC e-Factura (112)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- GrÃ¡fico de actividad -->
    <div class="grid">
      <div class="card table-card">
        <div class="flex-between" style="margin-bottom: 16px;">
          <h2 style="margin-bottom: 0;">Actividad Ãšltimos 7 DÃ­as</h2>
        </div>
        <div class="chart-container" id="activity-chart">
          <!-- Se llena dinÃ¡micamente -->
        </div>
        <div class="chart-labels" id="chart-labels">
          <!-- Se llena dinÃ¡micamente -->
        </div>
      </div>
    </div>

    <!-- Ãšltimos comprobantes y errores -->
    <div class="grid">
      <div class="card">
        <h2>Ãšltimos Comprobantes</h2>
        <div id="ultimos-comprobantes">
          <div class="empty-state">
            <div>ðŸ“„</div>
            <p>Cargando comprobantes...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Errores Recientes</h2>
        <div class="error-list" id="errores-recientes">
          <div class="empty-state">
            <div>âœ…</div>
            <p>Sin errores recientes</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de comprobantes -->
    <div class="grid">
      <div class="card table-card">
        <div class="flex-between" style="margin-bottom: 16px;">
          <h2 style="margin-bottom: 0;">Comprobantes Recientes</h2>
          <span class="stat-label" id="comprobantes-count">0 comprobantes</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Pedido</th>
              <th>Tipo</th>
              <th>NÃºmero</th>
              <th>CAE</th>
              <th>Fecha</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="comprobantes-table">
            <tr>
              <td colspan="6" style="text-align: center; color: var(--text-muted);">
                Cargando...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let refreshInterval = null;
    const API_BASE = window.location.origin;

    // Formatear uptime
    function formatUptime(seconds) {
      if (seconds < 60) return { value: seconds, label: 'segundos' };
      if (seconds < 3600) return { value: Math.floor(seconds / 60), label: 'minutos' };
      if (seconds < 86400) return { value: Math.floor(seconds / 3600), label: 'horas' };
      return { value: Math.floor(seconds / 86400), label: 'dÃ­as' };
    }

    // Formatear fecha
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('es-UY', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Obtener tipo de comprobante como string
    function getTipoStr(tipo) {
      const tipos = {
        101: 'e-Ticket',
        102: 'NC e-Ticket',
        111: 'e-Factura',
        112: 'NC e-Factura'
      };
      return tipos[tipo] || `Tipo ${tipo}`;
    }

    // Obtener clase de badge segÃºn tipo
    function getBadgeClass(tipo) {
      if (tipo === 101) return 'info';
      if (tipo === 111) return 'success';
      if (tipo === 102 || tipo === 112) return 'warning';
      return 'info';
    }

    // Actualizar estado de conexiÃ³n
    function updateConnectionStatus(connected, message = '') {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');

      if (connected) {
        dot.className = 'status-dot';
        text.textContent = 'Conectado';
      } else {
        dot.className = 'status-dot offline';
        text.textContent = message || 'Desconectado';
      }
    }

    // Actualizar circuit breakers
    function updateCircuitBreakers(circuits) {
      const container = document.getElementById('circuit-status');

      if (!circuits || Object.keys(circuits).length === 0) {
        container.innerHTML = '<div class="circuit"><span class="indicator closed"></span><span>Sin circuit breakers</span></div>';
        return;
      }

      container.innerHTML = Object.entries(circuits).map(([name, data]) => {
        const state = data.state || 'CLOSED';
        const indicatorClass = state === 'CLOSED' ? 'closed' : state === 'OPEN' ? 'open' : 'half-open';
        return `
          <div class="circuit">
            <span class="indicator ${indicatorClass}"></span>
            <span>${name}: ${state}</span>
          </div>
        `;
      }).join('');
    }

    // Actualizar grÃ¡fico de actividad
    function updateActivityChart(byDay) {
      const container = document.getElementById('activity-chart');
      const labels = document.getElementById('chart-labels');

      if (!byDay || Object.keys(byDay).length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Sin datos de actividad</p></div>';
        labels.innerHTML = '';
        return;
      }

      // Obtener Ãºltimos 7 dÃ­as
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        days.push({
          date: dateStr,
          count: byDay[dateStr] || 0,
          label: date.toLocaleDateString('es-UY', { weekday: 'short' })
        });
      }

      const maxCount = Math.max(...days.map(d => d.count), 1);

      container.innerHTML = days.map(day => {
        const height = (day.count / maxCount) * 100;
        return `
          <div class="chart-bar" style="height: ${Math.max(height, 2)}%">
            <div class="tooltip">${day.date}: ${day.count}</div>
          </div>
        `;
      }).join('');

      labels.innerHTML = days.map(day => `<span>${day.label}</span>`).join('');
    }

    // Actualizar tabla de comprobantes
    function updateComprobantesTable(comprobantes) {
      const tbody = document.getElementById('comprobantes-table');
      const count = document.getElementById('comprobantes-count');

      if (!comprobantes || comprobantes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Sin comprobantes</td></tr>';
        count.textContent = '0 comprobantes';
        return;
      }

      count.textContent = `${comprobantes.length} comprobantes`;

      // Mostrar Ãºltimos 10
      const recent = comprobantes.slice(0, 10);

      tbody.innerHTML = recent.map(c => `
        <tr>
          <td>${c.shopify_order_name || c.shopify_order_id || '-'}</td>
          <td><span class="badge ${getBadgeClass(c.tipo_comprobante)}">${getTipoStr(c.tipo_comprobante)}</span></td>
          <td>${c.serie || ''}-${c.numero || ''}</td>
          <td style="font-family: monospace; font-size: 12px;">${(c.cae_numero || '').substring(0, 10)}...</td>
          <td>${formatDate(c.created_at)}</td>
          <td><span class="badge success">Emitido</span></td>
        </tr>
      `).join('');
    }

    // Actualizar lista de errores
    function updateErrorsList(errors) {
      const container = document.getElementById('errores-recientes');

      if (!errors || errors.length === 0) {
        container.innerHTML = '<div class="empty-state"><div>âœ…</div><p>Sin errores recientes</p></div>';
        return;
      }

      container.innerHTML = errors.slice(0, 5).map(err => `
        <div class="error-item">
          <div class="error-type">${err.type || 'Error'}</div>
          <div class="error-message">${err.message || 'Sin mensaje'}</div>
          <div class="error-time">${formatDate(err.timestamp)} - Orden: ${err.context?.orderId || 'N/A'}</div>
        </div>
      `).join('');
    }

    // Cargar datos
    async function refreshData() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;

      try {
        // Obtener mÃ©tricas
        const response = await fetch(`${API_BASE}/metrics`);

        if (!response.ok) {
          throw new Error('Error obteniendo mÃ©tricas');
        }

        const data = await response.json();
        updateConnectionStatus(true);

        // Actualizar uptime
        const uptime = formatUptime(data.uptime || 0);
        document.getElementById('uptime').textContent = uptime.value;
        document.getElementById('uptime-label').textContent = uptime.label;

        // Actualizar webhooks
        document.getElementById('webhooks-procesados').textContent = data.webhooksProcesados || 0;
        document.getElementById('webhooks-duplicados').textContent = data.webhooksDuplicados || 0;

        // Actualizar comprobantes
        const stats = data.comprobantes || {};
        document.getElementById('total-comprobantes').textContent = stats.total || 0;
        document.getElementById('etickets').textContent = stats.eTickets || 0;
        document.getElementById('efacturas').textContent = stats.eFacturas || 0;
        document.getElementById('nc-etickets').textContent = stats.ncETickets || 0;
        document.getElementById('nc-efacturas').textContent = stats.ncEFacturas || 0;

        // Comprobantes hoy
        const today = new Date().toISOString().split('T')[0];
        const hoy = (stats.byFecha && stats.byFecha[today]) || 0;
        document.getElementById('comprobantes-hoy').textContent = hoy;

        // Actualizar circuit breakers
        updateCircuitBreakers(data.circuit ? { biller: data.circuit } : {});

        // Actualizar grÃ¡fico
        updateActivityChart(stats.byFecha || {});

        // Obtener lista de comprobantes
        try {
          const compResponse = await fetch(`${API_BASE}/api/comprobantes`);
          if (compResponse.ok) {
            const compData = await compResponse.json();
            updateComprobantesTable(compData.comprobantes || []);
          }
        } catch (e) {
          console.error('Error obteniendo comprobantes:', e);
        }

        // Obtener errores
        try {
          const errResponse = await fetch(`${API_BASE}/api/errors/unresolved`);
          if (errResponse.ok) {
            const errData = await errResponse.json();
            updateErrorsList(errData.errors || []);
          }
        } catch (e) {
          // Endpoint puede no existir aÃºn
          updateErrorsList([]);
        }

        // Actualizar timestamp
        document.getElementById('last-update').textContent =
          `Actualizado: ${new Date().toLocaleTimeString('es-UY')}`;

      } catch (error) {
        console.error('Error:', error);
        updateConnectionStatus(false, 'Error de conexiÃ³n');
      } finally {
        btn.disabled = false;
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      refreshData();

      // Auto-refresh cada 30 segundos
      refreshInterval = setInterval(refreshData, 30000);
    });

    // Limpiar al salir
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</body>
</html>
